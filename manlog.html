<!DOCTYPE html>
<html>
<head>
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta content="minimum-scale=1.0, width=device-width, maximum-scale=0.6667, user-scalable=no" name="viewport" />
<meta name="format-detection" content="telephone=no" />

<link rel="shortcut icon" type="image/x-icon" href="images/golf.png">
<link rel="shortcut icon" type="image/x-icon" href="images/golf.png?">
<title>Golfs du Qu&eacute;bec</title>
<meta content="Golf GPS, Qu&eacute;bec, Canada, Golf du Qu&eacute;bec, Clubs de golf au Qu&eacute;bec, Qu&eacute;bec golf" name="keywords" />
<meta content="R&eacute;pertoire des clubs de golf du Qu&eacute;bec. GPS golf." name="description" />
<link href="misc/init.css" rel="stylesheet" media="screen" type="text/css" />
<link href="misc/format.css" rel="stylesheet" media="screen" type="text/css" />
<link href="misc/datepicker.css" rel="stylesheet">

<script type="text/javascript" src="misc/util.js"></script>
<script src="misc/dateP.js"></script>
<script type="text/javascript" language="Javascript">
<!--

var fopo, arrExp = [], maxList = 50, editIp = false;
var userId = null, user_id = null, user_mail = null, user_name = null;

function initPage(){
fopo = document.getElementById('fHost');
var listItem = localStorage.getItem("ipList")
if (listItem ){
	arrExp = JSON.parse(listItem);
	refreshComboList(fopo.oComboList)
	selInList(fopo.oComboList)
}
var formPref = document.getElementById('formPref');
if (GetCookie("userRole") != "ADM")
	document.location.href = "index.html";
else{
	window.oMenu = new menuObject(document.getElementById('butMenu'));
	formPref.style.visibility="visible";
}

userId = GetCookie("userID");
window.oTip = new messTipObject();
setFontSize();
elemToScroll[0] = document.getElementById('prefLayer');
window.onscroll = scrollElement;
getInfo("getLogState?", showState);
showOptions(document.getElementById('menuOpt'))
}

function showState(res){
var lastArch = document.getElementById('lastArch');
var formPref = document.getElementById('formPref');

lastArch.innerHTML = res.mess;

if (formPref.prefDate.value == "" && res.last != 0)
	formPref.prefDate.value = formatDateTime.datetime(Math.round(res.last*1000)-3600000)
}

function saved(res){
if (res && res.mess)
	window.oTip.show('<text class="fontGreen">' + res.mess + '</text>', false, false, 300, -4);
else
	window.oTip.show('<text class="fontGreen">Saved</text>', false, false, 300, -4);
}

function showMenu(){
	window.oMenu.show();
}

function showOptions(menuOpt){
var divOptions = document.getElementById('divOptions');

if (divOptions.style.height != "0px" && divOptions.style.height != ""){
	divOptions.style.height = "0px";
	menuOpt.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;" + langLbl["mopti"];
	localStorage.setItem('optLogOpen', 'false');
}else{
	menuOpt.innerHTML = "&#10004;&nbsp;" + langLbl["mopti"];
	localStorage.setItem('optLogOpen', 'true');
	adjDivOpt(divOptions)
	}
}

function adjDivOpt(divOptions){
var prefReq = document.getElementById('prefReq');
var adj = prefReq.offsetTop + prefReq.offsetHeight - 75;
if (divOptions && (divOptions.style.height == "0px" || divOptions.style.height == "")){
	var fur = navigator.userAgent;
	divOptions.style.height = adj + "px";	
}else{
	var divOptions = document.getElementById('divOptions');
	if (divOptions && divOptions.style.height != "0px" && divOptions.style.height != "")
		divOptions.style.height = adj + "px";	
}
}

function popDtPicker(oTxtDt){
if (!window.dtPicker){
	window.dtPicker = new Datepicker(document.getElementById(oTxtDt));
	//window.dtPicker.config({format: d => {return getDateTime(d)}});
}
window.dtPicker.show(document.getElementById(oTxtDt));
//window.dtPicker.show();
}

function archiveLog(){
var divLoad = document.getElementById('divLoad');
if (confirm("Load log ?")){
	divLoad.style.display = "inherit";
	getInfo("loadLog", saved);
	//showMenu();
	setTimeout("location.reload();", 4000);
}
}

function getLogList(oF){
//getGameList
var divLoad = document.getElementById('divLoad');
var validPd = "", validPde = "";

var notIp = (oF.prefNotIp.checked) ? 1:0;

if (arrExp.length > 0){
	var ipExc = arrExp[0][0];
	for(var i = 1; i < arrExp.length; i++)
		ipExc += "$" + arrExp[i][0]
}

if (oF.prefDate.value)
	validPd = formatDateTime.datetimeToMilli(oF.prefDate.value)
if (oF.prefDateEnd.value)
	validPde = formatDateTime.datetimeToMilli(oF.prefDateEnd.value)

if (!validPd && validPd != ""){
	mess = "Invalid date time: " + oF.prefDate.value ;
	saved({mess});
	oF.prefDate.focus();
	oF.prefDate.select();
	}else if (!validPde && validPde != ""){
	mess = "Invalid date time: " + oF.prefDateEnd.value ;
	saved({mess});
	oF.prefDateEnd.focus();
	oF.prefDateEnd.select();
	}else{
		divLoad.style.display = "inherit";
		//var param = "?prefDate=" + validPd + "&prefDateEnd=" + validPde + "&prefNotIp=" + notIp + "&prefHost=" + oF.prefHost.value + "&prefStat=" + oF.prefStat.value + "&prefReq=" + oF.prefReq.value;
		var param = "?prefDate=" + validPd + "&prefDateEnd=" + validPde + "&prefNotIp=" + notIp + ((notIp ?  "&exList=" + ipExc:"")) + "&prefHost=" + oF.prefHost.value + "&prefStat=" + oF.prefStat.value + "&prefReq=" + oF.prefReq.value;
		getInfo("getLogs" + param, listLog);	
	}
}

function sortTable(noCol, colObj){

}

function listLog(data){
var logList = document.getElementById('logList');
var divLoad = document.getElementById('divLoad');
//sortArray = oLog;

oLog = data.logList;

logList.innerHTML = "";
if (data.cnt > data.max)
	logList.innerHTML = data.max + "/" + data.cnt + " refine for all"
else
	logList.innerHTML = data.cnt + " logs items";
	
divLoad.style.display = "none";
var theadElem = document.createElement("thead");
var tbodyElem = document.createElement("tbody");
logList.appendChild(theadElem);
logList.appendChild(tbodyElem);

var thElem = document.createElement("tr");
thElem.setAttribute('title', 'Click to sort');
thElem.innerHTML = '<th onclick="sortTable(0, this)">Time</th><th onclick="sortTable(1, this)">Status</th><th onclick="sortTable(2, this)">IP</th><th >Detail</th>';
theadElem.appendChild(thElem);

var arrHDP = [];
var Tcode = "";
for (var i = 0; i < oLog.length; i++) {
    var scoreID = oLog[i].date;
    var time = oLog[i].time;
    var status = oLog[i].status;
    var ip = oLog[i].ip;
    Tcode += '<tr class="norm" ontouchstart="this.className=\'rowOver\'" ontouchend="this.className=\'rowNorm\'" onmouseover="this.className=\'rowOver\'" onmouseout="this.className=\'rowNorm\'" onclick="showDetail(this);">';
    Tcode += '<td>' + formatDateTime.datetime(time) + '</td><td>' + status + '</td><td>' + ip + '</td>';
    Tcode += '<td class="logDetail"><div class="divDetail">' + oLog[i].request + '</br>' + oLog[i].referer + '</br>' + oLog[i].user_agent + '</br>' + '</div></td></tr>';
    //sortArray[i] = [ scoreID , (scoreData[i].score_date) , courseName , gt ];
}
//alert(i);
tbodyElem.innerHTML = Tcode;

}

function showDetail(oTR, toClose){
var prefLayer = document.getElementById('prefLayer');
if (toClose){
    prefLayer.style.visibility = "hidden";
    return false;
}
if (editIp)
	return false;
var htmlCode = '<table class="cartePts"><th>Time</th><th>Status</th><th>IP</th>';
htmlCode +=  '<tr><td>' + oTR.childNodes[0].innerHTML + '</td><td>' + oTR.childNodes[1].innerHTML + '</td><td>' + oTR.childNodes[2].innerHTML + '</td></tr></table>';
htmlCode += '<div class="logDetail">' + oTR.childNodes[3].childNodes[0].innerHTML + '</div>';
htmlCode += '<button class="bouton" onclick="showDetail(false, true)">Close</button>';
prefLayer.innerHTML = htmlCode;
prefLayer.style.visibility = "visible";

return false;
}


function selInList(oLB){
if (oLB.selectedIndex != -1){
	fopo.oTextBox.value = arrExp[oLB.selectedIndex][0];
	fopo.oTextDesc.value = arrExp[oLB.selectedIndex][1];
}
}

function addHost(){
var exp = fopo.oTextBox.value;
var desc = fopo.oTextDesc.value;

	var index = getIPindex(exp);
	if (index > -1) {
	  arrExp.splice(index, 1);
	  arrExp.unshift([exp, desc]);
	}else{
	  arrExp[arrExp.length] = [exp, desc];
	}
	
	if (arrExp.length > maxList - 1)
		alert("Limit " + maxList + " reached.");
	if (arrExp.length > maxList){
		arrExp.splice(0, 1);
	}
		
	refreshComboList(fopo.oComboList);
}

function refreshComboList(oCombo){
while (oCombo.childNodes.length > 0) {
    oCombo.removeChild(oCombo.childNodes[0]);
}
//for(var i = arrExp.length - 1; i >= 0; i--){
for(var i = 0; i < arrExp.length; i++){
	var newNode = document.createElement("option");
	newNode.innerHTML = arrExp[i][0] + " - " + arrExp[i][1];
	fopo.oComboList.appendChild(newNode);
}
}

function getIPindex(x){
var index = -1;
for (var i = 0; i < arrExp.length; i++){
	if (arrExp[i][0] == x)
		var index = i;
}
return index;
}

function delSel(){
var index = getIPindex(fopo.oTextBox.value)
if (index > -1) {
  arrExp.splice(index, 1);
}
fopo.oTextBox.value = "";
fopo.oTextDesc.value = "";
refreshComboList(fopo.oComboList);
}

function showIpList(){
var prefLayer = document.getElementById('prefLayer');
var oComboBox = document.getElementById('oComboBox');
prefLayer.innerHTML = "";
prefLayer.appendChild(oComboBox);
editIp = true;
prefLayer.style.visibility = "visible";
oComboBox.style.visibility = "visible";
}

function saveContext(saveData){
var eBod = document.getElementsByTagName('body')[0];
var oComboBox = document.getElementById('oComboBox');
//alert(arrExp);
oComboBox.style.visibility = "hidden";
if (saveData)
	localStorage.setItem("ipList", JSON.stringify(arrExp));
editIp = false;
showDetail(false, true);
eBod.appendChild(oComboBox);
}

// -->
</script>

<style>
#butMenu{
visibility: visible;
}
#divOptions{
height: 0px;
overflow: hidden;
transition: height 0.4s ease-in-out;
background: rgb(238, 238, 238);
}
.formItem{
display: inline-block;
    border: none;
}

.logDetail{
text-align: left;
word-wrap: anywhere;
width: 100%;
}

.divDetail{
height: 2.5em;
overflow: hidden;
}

#logList{showOptions
width: 100%;
display: block;
}

table.cartePts th,td{
    border: solid white 1px;

    text-align: left;
}

table.cartePts{
    margin: 0 auto;
}

#oTextBox, #oTextDesc{
width: 155px; 
z-index: 2;
border:none;
width: 10em;
}
#oComboList{
z-index: 1; 
width: 11em;
}
#oComboBox{
position: relative;
visibility: hidden;
text-align: left;
display: inline-block;
}
#closeCombo{
    margin-left: 5em;
}

</style>

</head>

<body onload="initPage();"><a name="haut"></a>

<div id="topbar" class="vert">
<div id="leftnav"><a title="Formulaire de recherche" href="index.html"><img alt="Formulaire de recherche" height="22" width="25" src="images/home22.png" /></a></div>
<span>LOG</span>
<div id="fontAdjust" class="unselectable">
<div class="divFont" onclick="setFontSize(0.2, this)"><div class="divFontSize">A</div><div class="fontLogo">&#8593;</div></div>
<div class="divFont" onclick="setFontSize(-0.2, this)"><div class="divFontSize fontSmall">A</div><div class="fontLogo">&#8595;</div></div>
</div>
</div>
<div id="duobutton">
<a href="#" id="butMenu" title="Menu" onmouseover="showMenu()" onclick="showMenu()"><img id="logomenu" alt="Menu" src="images/menu.png" width="64" height="32"></a>

<a id="lAdmin" href="admin.html" >Manage</a>
</div>

<div id="menuList">
<a class="inputButton" href="#" onclick="archiveLog();" title="Archiver les logs.">&nbsp;&nbsp;&nbsp;&nbsp;Archiver</a>
<a id="menuOpt" class="inputButton" href="#" onclick="showOptions(this);" title="Options de recherche.">&nbsp;&nbsp;&nbsp;&nbsp;<text id="mopti">Options</text></a>
</div>

<div>Last archive: <span id="lastArch"></span></div>

<form id="formPref" action="#">

<div id="divOptions" class="prefPart">

	<div>
		<div class="formItem">
		<label for="prefDate">From :</label></br>
			<input id="prefDate" name="prefDate" size="16" type="text" maxlength="16" value="" placeholder="yyyy-mm-dd hh:mm"/> 
			<a id="calIcon" class="char_icon" href="javascript:popDtPicker('prefDate');">&#128197;</a>
		</div> 
		<div class="formItem">		
		<label for="prefDateEnd">To :</label></br>
			<input id="prefDateEnd" name="prefDateEnd" size="16" type="text" maxlength="16" value="" placeholder="yyyy-mm-dd hh:mm"/>
			<a id="calIcon" class="char_icon" href="javascript:popDtPicker('prefDateEnd');">&#128197;</a>
		</div> 
	</div>
	<div>		
		<div class="formItem">		
		<label for="prefNotIp">Exclus</label></br>
			<input id="prefNotIp" name="prefNotIp" type="checkbox" >
			<a class="itin"  href="#" onclick="showIpList();">...</a>
		</div> 
		<div class="formItem">		
		<label for="prefHost">Host - IP: </label></br>
			<input id="prefHost" name="prefHost" size="25" type="text" maxlength="15" value=""/> 
		</div>		
		<div class="formItem">
		<label for="prefStat">Status: </label></br>
		<select id="prefStat" name="prefStat"> 
			<option value="0" selected="selected">All</option>
			<option value="1" >Not 200</option>
		</select>
		</div> 
	</div>
	<div>	
		<div class="formItem">	
		<label for="prefReq">Request: </label></br>
			<input id="prefReq" name="prefReq" size="40" type="text" maxlength="200" value=""/> 
		</div>
		<button class="formItem" onclick="getLogList(this.form);">
		<a class="itin char_icon" href="#" >&#x21bb;</a>
		</button>
	</div>

</div>

<div id="p1" name="p1" class="unselectable">
	<table id="logList" class="cartePts">

	</table>
	<div id="divLoad"><img id="imgLoad" alt="Chargement en cours..." src="images/loading.gif" /></div>
</div>

</form>


<div id="bottombar" class="vert">
</div>


<div id="copyright">
<a href="mailto:cdore00@yahoo.ca?Subject=Golfs%20du%20Qu&eacute;bec">Copyright &copy; 2005-2018</a>
</div>

<div id="prefLayer"></div>
<div id="modalDiv"></div>

<div id="authLayer" class="winLayer">
<div id="divLoad"><img id="imgLoad" alt="Chargement en cours..." height="64" width="64" src="images/loading.gif" /></div>
</div>

<div id="oComboBox">
<h3>IP Exclusions</h3>
<form id="fHost" action="#">
<input type="text" id="oTextBox" tabindex="2" />
<button class="formItem" onClick="addHost();">
<a class="itin char_icon" href="#">&#9989;</a>
</button>
<button class="formItem" onClick="delSel();">
<a class="itin char_icon" href="#">&#9940;</a>
</button>
</br><input type="text" id="oTextDesc" tabindex="3" /></br>
<div  id="divComboList">
	<select id="oComboList" size="5" tabindex="1000" onchange="selInList(this);" >
	</select>
</div>

<input id="okPref" class="bouton" type="submit" onClick="saveContext(true); return false;" value="_okok" /><input id="annulePref" class="bouton" type="button" onClick="saveContext(); return false;" value="_canc" />
</form>
</div>


</body>

</html>